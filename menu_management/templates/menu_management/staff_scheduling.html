{% extends 'base.html' %}

{% block title %}Staff Scheduling - Zabu Restaurant{% endblock %}

{% block extra_css %}
<style>
    .scheduling-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .view-controls {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .schedule-grid {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .schedule-item {
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .staff-member {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .staff-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-weight: bold;
    }
    
    .shift-time {
        background: #e3f2fd;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        font-size: 0.875rem;
        color: #1976d2;
    }
    
    .btn-schedule {
        background: #667eea;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .btn-schedule:hover {
        background: #5a67d8;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    
    .date-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .view-toggle {
        display: flex;
        gap: 0.5rem;
    }
    
    .view-toggle button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
    }
    
    .view-toggle button.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="scheduling-header">
    <div class="container">
        <h1>üë• Staff Scheduling</h1>
        <p class="mb-0">Manage staff schedules and shifts</p>
    </div>
</div>

<div class="container">
    <!-- View Controls -->
    <div class="view-controls">
        <div class="date-navigation">
            <button class="btn btn-outline-primary" onclick="navigateDate('prev')">
                ‚Üê Previous
            </button>
            <h4 class="mb-0">{{ view_date|date:"F d, Y" }}</h4>
            <button class="btn btn-outline-primary" onclick="navigateDate('next')">
                Next ‚Üí
            </button>
        </div>
        
        <div class="view-toggle">
            <button class="btn {% if view_type == 'day' %}active{% endif %}" onclick="changeView('day')">Day</button>
            <button class="btn {% if view_type == 'week' %}active{% endif %}" onclick="changeView('week')">Week</button>
            <button class="btn {% if view_type == 'month' %}active{% endif %}" onclick="changeView('month')">Month</button>
        </div>
        
        <div>
            <button class="btn btn-primary" onclick="showScheduleModal()">
                ‚ûï Add Schedule
            </button>
        </div>
    </div>

    <!-- Schedule Grid -->
    <div class="schedule-grid">
        <h3 class="mb-4">Schedule for {{ view_date|date:"l, F d, Y" }}</h3>
        
        {% if schedules %}
            {% for schedule in schedules %}
            <div class="schedule-item" data-schedule-id="{{ schedule.schedule_id }}">
                <div class="staff-member">
                    <div class="staff-avatar">
                        {{ schedule.staff.user.first_name.0 }}{{ schedule.staff.user.last_name.0 }}
                    </div>
                    <div>
                        <strong>{{ schedule.staff.user.get_full_name }}</strong>
                        <br>
                        <small class="text-muted">{{ schedule.staff.position }}</small>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div>
                        <span class="shift-time">{{ schedule.start_time|date:"H:i" }} - {{ schedule.end_time|date:"H:i" }}</span>
                        {% if schedule.shift_template %}
                        <span class="badge bg-info ms-2">{{ schedule.shift_template.name }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <span class="badge {% if schedule.status == 'confirmed' %}bg-success{% elif schedule.status == 'draft' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ schedule.get_status_display }}
                        </span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="editSchedule('{{ schedule.schedule_id }}')">
                            Edit
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <h4>No schedules found</h4>
                <p>There are no schedules for {{ view_date|date:"F d, Y" }}</p>
                <button class="btn btn-primary" onclick="showScheduleModal()">
                    Add First Schedule
                </button>
            </div>
        {% endif %}
    </div>

    <!-- Active Staff -->
    <div class="schedule-grid mt-4">
        <h3 class="mb-4">Active Staff</h3>
        
        {% if active_staff %}
            <div class="row">
                {% for staff in active_staff %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="staff-avatar">
                                    {{ staff.user.first_name.0 }}{{ staff.user.last_name.0 }}
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ staff.user.get_full_name }}</h6>
                                    <small class="text-muted">{{ staff.position }}</small>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-schedule" onclick="quickSchedule({{ staff.id }})">
                                    Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <h4>No active staff found</h4>
                <p>There are no active staff members available for scheduling.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <div class="mb-3">
                        <label for="staffSelect" class="form-label">Staff Member</label>
                        <select class="form-select" id="staffSelect" required>
                            <option value="">Select staff member...</option>
                            {% for staff in active_staff %}
                            <option value="{{ staff.id }}">{{ staff.user.get_full_name }} - {{ staff.position }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shiftTemplate" class="form-label">Shift Template</label>
                        <select class="form-select" id="shiftTemplate">
                            <option value="">Custom shift...</option>
                            {% for template in shift_templates %}
                            <option value="{{ template.id }}">{{ template.name }} ({{ template.start_time|date:"H:i" }} - {{ template.end_time|date:"H:i" }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status">
                            <option value="draft">Draft</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">Save Schedule</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Add click handler for close button
    notification.querySelector('.btn-close').addEventListener('click', () => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

function showScheduleModal(scheduleId = null) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    
    if (scheduleId) {
        // Load existing schedule data
        loadScheduleData(scheduleId);
        document.querySelector('#scheduleModal .modal-title').textContent = 'Edit Schedule';
    } else {
        // Reset form for new schedule
        document.getElementById('scheduleForm').reset();
        document.querySelector('#scheduleModal .modal-title').textContent = 'Add Schedule';
        // Clear any existing schedule ID from modal
        delete document.getElementById('scheduleModal').dataset.scheduleId;
    }
    
    modal.show();
}

function changeView(viewType) {
    const url = new URL(window.location);
    url.searchParams.set('view', viewType);
    window.location.href = url.toString();
}

function navigateDate(direction) {
    const currentDate = new Date('{{ view_date|date:"Y-m-d" }}');
    let newDate;
    
    if (direction === 'prev') {
        newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() - 1);
    } else {
        newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() + 1);
    }
    
    const url = new URL(window.location);
    url.searchParams.set('date', newDate.toISOString().split('T')[0]);
    window.location.href = url.toString();
}

function quickSchedule(staffId) {
    document.getElementById('staffSelect').value = staffId;
    showScheduleModal();
}

function loadScheduleData(scheduleId) {
    fetch(`/menu-management/api/schedule/${scheduleId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate form with existing data
                document.getElementById('staffSelect').value = data.schedule.staff_id || '';
                document.getElementById('shiftTemplate').value = data.schedule.shift_template_id || '';
                document.getElementById('startTime').value = data.schedule.start_time || '';
                document.getElementById('endTime').value = data.schedule.end_time || '';
                document.getElementById('status').value = data.schedule.status || 'draft';
                
                // Store schedule ID for update operation
                document.getElementById('scheduleModal').dataset.scheduleId = scheduleId;
            } else {
                showNotification('error', 'Failed to load schedule data: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', 'Error loading schedule data: ' + error.message);
        });
}

function editSchedule(scheduleId) {
    showScheduleModal(scheduleId);
}

function saveSchedule() {
    const form = document.getElementById('scheduleForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = {
        staff_id: document.getElementById('staffSelect').value,
        date: '{{ view_date|date:"Y-m-d" }}',
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value,
        shift_template_id: document.getElementById('shiftTemplate').value || null,
        break_duration: 30,
        station: '',
        role: '',
        status: document.getElementById('status').value,
        notes: '',
        is_overtime: false
    };
    
    // Get schedule ID from modal dataset
    const modal = document.getElementById('scheduleModal');
    const scheduleId = modal.dataset.scheduleId;
    
    const url = scheduleId ? 
        `/menu-management/api/schedule/${scheduleId}/update/` : 
        '/menu-management/api/schedule/create/';
    
    const method = scheduleId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', data.message);
            const modalInstance = bootstrap.Modal.getInstance(modal);
            modalInstance.hide();
            // Clear the schedule ID from modal
            delete modal.dataset.scheduleId;
            // Refresh the page to show updated schedule
            location.reload();
        } else {
            showNotification('error', data.error || 'Failed to save schedule');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', 'Error saving schedule: ' + error.message);
    });
}

function deleteSchedule(scheduleId) {
    if (confirm('Are you sure you want to delete this schedule?')) {
        fetch(`/menu-management/api/schedule/${scheduleId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', data.message);
                location.reload();
            } else {
                showNotification('error', data.error || 'Failed to delete schedule');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', 'Error deleting schedule');
        });
    }
}

// Handle shift template selection
document.getElementById('shiftTemplate').addEventListener('change', function() {
    const templateId = this.value;
    if (templateId) {
        fetch(`/menu-management/api/shift-template/${templateId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate time fields from template
                    document.getElementById('startTime').value = data.template.start_time;
                    document.getElementById('endTime').value = data.template.end_time;
                } else {
                    console.error('Error loading template:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    } else {
        // Clear time fields when no template selected
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
    }
});

// Add delete buttons to existing schedules
document.addEventListener('DOMContentLoaded', function() {
    const scheduleItems = document.querySelectorAll('.schedule-item');
    scheduleItems.forEach(item => {
        const scheduleId = item.dataset.scheduleId;
        if (scheduleId) {
            const editBtn = item.querySelector('.btn-outline-secondary');
            if (editBtn) {
                // Add delete button next to edit button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-outline-danger ms-2';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteSchedule(scheduleId);
                editBtn.parentNode.appendChild(deleteBtn);
            }
        }
    });
});
</script>
{% endblock %}
