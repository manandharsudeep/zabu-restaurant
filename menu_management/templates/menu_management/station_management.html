{% extends 'base.html' %}

{% block title %}Station Management - Zabu Restaurant{% endblock %}

{% block extra_css %}
<style>
    .station-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .station-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .station-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    
    .station-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }
    
    .station-header-info {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .station-name {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }
    
    .station-type {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .station-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .status-available { background: #28a745; }
    .status-busy { background: #ffc107; }
    .status-full { background: #dc3545; }
    .status-offline { background: #6c757d; }
    
    .station-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .metric {
        text-align: center;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .metric-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .efficiency-meter {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .efficiency-fill {
        height: 100%;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        transition: width 0.3s ease;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .control-panel {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #667eea;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Station Management Header -->
<div class="station-header">
    <div class="container">
        <div class="text-center">
            <h1 class="display-5">üç≥ Station Management</h1>
            <p class="lead">Smart kitchen station routing and load balancing</p>
        </div>
    </div>
</div>

<div class="container">
    <!-- Statistics Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-number">{{ total_stations }}</div>
            <div class="stat-label">Total Stations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_stations }}</div>
            <div class="stat-label">Active Stations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_orders }}</div>
            <div class="stat-label">Active Orders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ station_status|length }}</div>
            <div class="stat-label">Station Types</div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <h3>üéõÔ∏è Control Panel</h3>
        <div class="row">
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="rebalanceOrders()">
                    ‚öñÔ∏è Rebalance Orders
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-success w-100" onclick="optimizeStations()">
                    üìà Optimize Performance
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-info w-100" onclick="refreshStations()">
                    üîÑ Refresh Status
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-warning w-100" onclick="showCreateStationModal()">
                    ‚ûï Add Station
                </button>
            </div>
        </div>
    </div>

    <!-- Station Grid -->
    <div class="station-grid">
        {% for station_data in station_status %}
        <div class="station-card">
            <div class="station-header-info">
                <div class="station-name">{{ station_data.station.name }}</div>
                <div class="station-type">{{ station_data.station.get_station_type_display }}</div>
            </div>
            
            <div class="station-status">
                <div class="status-indicator 
                     {% if station_data.is_available %}status-available
                     {% elif station_data.load_percentage > 80 %}status-full
                     {% else %}status-busy{% endif %}">
                </div>
                <span>
                    {% if station_data.is_available %}Available
                    {% elif station_data.load_percentage > 80 %}Full Capacity
                    {% else %}Busy{% endif %}
                </span>
            </div>
            
            <div class="station-metrics">
                <div class="metric">
                    <div class="metric-value">{{ station_data.current_orders }}</div>
                    <div class="metric-label">Current Orders</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{{ station_data.load_percentage|floatformat:0 }}%</div>
                    <div class="metric-label">Load</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{{ station_data.efficiency }}%</div>
                    <div class="metric-label">Efficiency</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{{ station_data.avg_time|floatformat:1 }}m</div>
                    <div class="metric-label">Avg Time</div>
                </div>
            </div>
            
            <div class="mb-2">
                <small class="text-muted">
                    Capacity: {{ station_data.capacity }} | 
                    Staff: {{ station_data.staff_count }}
                </small>
            </div>
            
            <div class="efficiency-meter">
                <div class="efficiency-fill" style="width: {{ station_data.efficiency }}%"></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-sm btn-primary" onclick="viewStationDetails('{{ station_data.station.id }}')">
                    üëÅÔ∏è Details
                </button>
                <button class="btn btn-sm btn-warning" onclick="editStation('{{ station_data.station.id }}')">
                    ‚úèÔ∏è Edit
                </button>
                <button class="btn btn-sm {% if station_data.station.is_active %}btn-danger{% else %}btn-success{% endif %}" 
                        onclick="toggleStation('{{ station_data.station.id }}')">
                    {% if station_data.station.is_active %}üî¥ Disable{% else %}üü¢ Enable{% endif %}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create Station Modal -->
<div id="createStationModal" class="modal">
    <div class="modal-content">
        <h3>‚ûï Create New Station</h3>
        <form id="createStationForm">
            <div class="form-group">
                <label for="stationName">Station Name</label>
                <input type="text" id="stationName" name="name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="stationType">Station Type</label>
                <select id="stationType" name="station_type" class="form-control" required>
                    <option value="prep">Prep Station</option>
                    <option value="grill">Grill Station</option>
                    <option value="saut√©">Saut√© Station</option>
                    <option value="fry">Fry Station</option>
                    <option value="cold">Cold Prep Station</option>
                    <option value="pastry">Pastry Station</option>
                    <option value="packaging">Packaging Station</option>
                    <option value="expedite">Expedite Station</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stationCapacity">Capacity</label>
                <input type="number" id="stationCapacity" name="capacity" class="form-control" min="1" max="20" value="5" required>
            </div>
            <div class="form-group">
                <label for="stationPrepTime">Avg Preparation Time (minutes)</label>
                <input type="number" id="stationPrepTime" name="avg_preparation_time" class="form-control" min="1" value="10" required>
            </div>
            <div class="form-group">
                <label for="stationEquipment">Equipment (comma-separated)</label>
                <input type="text" id="stationEquipment" name="equipment" class="form-control" placeholder="grill, fryer, prep table">
            </div>
            <div class="form-group">
                <label for="stationCapabilities">Capabilities (comma-separated)</label>
                <input type="text" id="stationCapabilities" name="capabilities" class="form-control" placeholder="grill, fry, saut√©, cold prep">
            </div>
            <div class="text-end">
                <button type="button" class="btn btn-secondary" onclick="hideCreateStationModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Station</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Station Modal -->
<div id="editStationModal" class="modal">
    <div class="modal-content">
        <h3>‚úèÔ∏è Edit Station</h3>
        <form id="editStationForm">
            <input type="hidden" id="editStationId" name="station_id">
            <div class="form-group">
                <label for="editStationName">Station Name</label>
                <input type="text" id="editStationName" name="name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editStationType">Station Type</label>
                <select id="editStationType" name="station_type" class="form-control" required>
                    <option value="prep">Prep Station</option>
                    <option value="grill">Grill Station</option>
                    <option value="saut√©">Saut√© Station</option>
                    <option value="fry">Fry Station</option>
                    <option value="cold">Cold Prep Station</option>
                    <option value="pastry">Pastry Station</option>
                    <option value="packaging">Packaging Station</option>
                    <option value="expedite">Expedite Station</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editStationCapacity">Capacity (max concurrent orders)</label>
                <input type="number" id="editStationCapacity" name="capacity" class="form-control" min="1" max="50" required>
            </div>
            <div class="form-group">
                <label for="editStationPrepTime">Avg Preparation Time (minutes)</label>
                <input type="number" id="editStationPrepTime" name="avg_preparation_time" class="form-control" min="1" max="120" required>
            </div>
            <div class="form-group">
                <label for="editStationEquipment">Equipment (comma-separated)</label>
                <input type="text" id="editStationEquipment" name="equipment" class="form-control" placeholder="grill, fryer, oven, mixer">
            </div>
            <div class="form-group">
                <label for="editStationCapabilities">Capabilities (comma-separated)</label>
                <input type="text" id="editStationCapabilities" name="capabilities" class="form-control" placeholder="grill, fry, saut√©, cold prep">
            </div>
            <div class="form-check mb-3">
                <input type="checkbox" id="editStationActive" name="is_active" class="form-check-input">
                <label for="editStationActive" class="form-check-label">Station Active</label>
            </div>
            <div class="text-end">
                <button type="button" class="btn btn-secondary" onclick="hideEditStationModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Station</button>
            </div>
        </form>
    </div>
</div>

<script>
// Control Panel Functions
function rebalanceOrders() {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Rebalancing...';
    button.disabled = true;
    
    fetch('/menu-management/rebalance-orders/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            throw new Error('Invalid response format');
        }
    })
    .then(data => {
        if (data.success) {
            // Show success message in a better way
            showNotification('success', data.message || 'Orders rebalanced successfully!');
            
            // Update station data if needed
            if (data.station_loads) {
                updateStationLoads(data.station_loads);
            }
            
            // Refresh stations data
            refreshStations();
        } else {
            showNotification('error', data.message || 'Failed to rebalance orders');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', 'An error occurred while rebalancing orders: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Helper function to show notifications
function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Add click handler for close button
    notification.querySelector('.btn-close').addEventListener('click', () => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

// Helper function to update station loads display
function updateStationLoads(stationLoads) {
    // Update station load displays if they exist on the page
    Object.keys(stationLoads).forEach(stationName => {
        const loadElement = document.querySelector(`[data-station="${stationName}"] .station-load`);
        if (loadElement) {
            loadElement.textContent = stationLoads[stationName] + ' items';
        }
    });
}

function optimizeStations() {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Optimizing...';
    button.disabled = true;
    
    fetch('/menu-management/stations/optimize/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            throw new Error('Invalid response format');
        }
    })
    .then(data => {
        if (data.success) {
            // Show success message in a better way
            showNotification('success', data.message || 'Station performance optimized successfully!');
            refreshStations();
        } else {
            showNotification('error', data.message || 'Failed to optimize stations');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', 'An error occurred while optimizing stations: ' + error.message);
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function refreshStations() {
    location.reload();
}

// Station Management Functions
function viewStationDetails(stationId) {
    window.location.href = `/menu-management/stations/${stationId}/`;
}

function editStation(stationId) {
    // Fetch station details and populate edit form
    fetch(`/menu-management/stations/${stationId}/`, {
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => response.json())
        .then(station => {
            // Populate edit form with station data
            document.getElementById('editStationId').value = station.id;
            document.getElementById('editStationName').value = station.name;
            document.getElementById('editStationType').value = station.station_type;
            document.getElementById('editStationCapacity').value = station.capacity;
            document.getElementById('editStationPrepTime').value = station.avg_preparation_time;
            document.getElementById('editStationEquipment').value = station.equipment.join(', ');
            document.getElementById('editStationCapabilities').value = station.capabilities.join(', ');
            document.getElementById('editStationActive').checked = station.is_active;
            
            // Show edit modal
            showEditStationModal();
        })
        .catch(error => {
            console.error('Error fetching station details:', error);
            alert('Error loading station details. Please try again.');
        });
}

function toggleStation(stationId) {
    // Implementation for toggling station status
    alert('Toggle station functionality coming soon!');
}

// Modal Functions
function showCreateStationModal() {
    document.getElementById('createStationModal').style.display = 'block';
}

function hideCreateStationModal() {
    document.getElementById('createStationModal').style.display = 'none';
}

function showEditStationModal() {
    document.getElementById('editStationModal').style.display = 'block';
}

function hideEditStationModal() {
    document.getElementById('editStationModal').style.display = 'none';
}

// Create Station Form
document.getElementById('createStationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        name: formData.get('name'),
        station_type: formData.get('station_type'),
        capacity: formData.get('capacity'),
        avg_preparation_time: formData.get('avg_preparation_time'),
        equipment: formData.get('equipment').split(',').map(item => item.trim()).filter(item => item),
        capabilities: formData.get('capabilities').split(',').map(item => item.trim()).filter(item => item),
    };
    
    fetch('/menu-management/stations/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Station created successfully!');
            hideCreateStationModal();
            refreshStations();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the station.');
    });
});

// Edit Station Form
document.getElementById('editStationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const stationId = formData.get('station_id');
    const data = {
        name: formData.get('name'),
        station_type: formData.get('station_type'),
        capacity: formData.get('capacity'),
        avg_preparation_time: formData.get('avg_preparation_time'),
        equipment: formData.get('equipment').split(',').map(item => item.trim()).filter(item => item),
        capabilities: formData.get('capabilities').split(',').map(item => item.trim()).filter(item => item),
        is_active: formData.get('is_active') === 'on'
    };
    
    fetch(`/menu-management/stations/${stationId}/update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Station "${data.name}" updated successfully!`);
            hideEditStationModal();
            refreshStations();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the station.');
    });
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const createModal = document.getElementById('createStationModal');
    const editModal = document.getElementById('editStationModal');
    
    if (event.target == createModal) {
        createModal.style.display = 'none';
    }
    if (event.target == editModal) {
        editModal.style.display = 'none';
    }
}
</script>
{% endblock %}
