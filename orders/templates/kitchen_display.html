{% extends 'base.html' %}

{% block title %}Kitchen Display - Restaurant System{% endblock %}

{% block extra_css %}
<style>
    .kitchen-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .order-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
    }
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .order-card.status-pending { border-left-color: #ffc107; }
    .order-card.status-confirmed { border-left-color: #17a2b8; }
    .order-card.status-preparing { border-left-color: #fd7e14; }
    .order-card.status-ready { border-left-color: #28a745; }
    .order-card.status-completed { border-left-color: #6c757d; opacity: 0.7; }
    .order-card.status-cancelled { border-left-color: #dc3545; opacity: 0.5; }
    
    .order-time {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .item-row {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    .item-row:last-child {
        border-bottom: none;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
    }
    .priority-high {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
    }
    .auto-refresh {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    .kitchen-stats {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .stat-item {
        text-align: center;
        padding: 1rem;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="kitchen-header">
    <div class="container">
        <h1 class="text-center mb-0">üç≥ Kitchen Display System</h1>
        <p class="text-center mb-0 mt-2">Real-time order tracking and management</p>
    </div>
</div>

<div class="auto-refresh">
    <small class="text-muted">Auto-refresh in <span id="countdown">30</span>s</small>
    <button class="btn btn-sm btn-outline-primary ms-2" onclick="location.reload()">Refresh Now</button>
</div>

<div class="container">
    <div class="kitchen-stats">
        <div class="row">
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.pending }}</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.preparing }}</div>
                    <div class="stat-label">Preparing</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.ready }}</div>
                    <div class="stat-label">Ready</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.total_today }}</div>
                    <div class="stat-label">Total Today</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <h3>Active Orders</h3>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm active" onclick="filterOrders('all')">All</button>
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterOrders('pending')">Pending</button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="filterOrders('confirmed')">Confirmed</button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="filterOrders('preparing')">Preparing</button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="filterOrders('ready')">Ready</button>
            </div>
        </div>
    </div>

    <div id="orders-container">
        {% for order in orders %}
            <div class="card order-card status-{{ order.status }}" data-status="{{ order.status }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Order #{{ order.order_number }}</h5>
                        <small class="order-time">
                            {{ order.created_at|date:"H:i" }} ‚Ä¢ 
                            {% if order.table_number %}Table {{ order.table_number }}{% else %}Takeaway{% endif %}
                            ‚Ä¢ {{ order.customer_name }}
                        </small>
                    </div>
                    <div>
                        <span class="badge status-badge order-status status-{{ order.status }}">
                            {{ order.get_status_display }}
                        </span>
                    </div>
                </div>
                
                <div class="card-body">
                    {% if order.notes %}
                        <div class="alert alert-info py-2 mb-3">
                            <small><strong>Notes:</strong> {{ order.notes }}</small>
                        </div>
                    {% endif %}
                    
                    {% for item in order.items.all %}
                        <div class="item-row">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>{{ item.quantity }}x</strong> {{ item.menu_item.name }}
                                    {% if item.notes %}
                                        <br><small class="text-muted">Note: {{ item.notes }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">‚è±Ô∏è {{ item.menu_item.preparation_time }} mins</small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <span class="text-muted">Nrs {{ item.total_price }}</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <div class="mt-3 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Total: Nrs {{ order.total_amount }}</strong>
                            </div>
                            <div class="col-md-6 text-end">
                                {% if order.status == 'pending' %}
                                    <form action="{% url 'update_order_status' order.id 'confirmed' %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-info">Confirm Order</button>
                                    </form>
                                {% elif order.status == 'confirmed' %}
                                    <form action="{% url 'update_order_status' order.id 'preparing' %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger">Start Preparing</button>
                                    </form>
                                {% elif order.status == 'preparing' %}
                                    <form action="{% url 'update_order_status' order.id 'ready' %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-success">Mark Ready</button>
                                    </form>
                                {% elif order.status == 'ready' %}
                                    <form action="{% url 'update_order_status' order.id 'completed' %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-secondary">Complete</button>
                                    </form>
                                {% endif %}
                                
                                {% if order.status not in 'completed,cancelled' %}
                                    <form action="{% url 'update_order_status' order.id 'cancelled' %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Cancel this order?')">Cancel</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="text-center py-5">
                <h4 class="text-muted">No active orders</h4>
                <p class="text-muted">All orders have been completed!</p>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let countdown = 30;
const countdownElement = document.getElementById('countdown');

setInterval(() => {
    countdown--;
    if (countdownElement) {
        countdownElement.textContent = countdown;
    }
    if (countdown <= 0) {
        location.reload();
    }
}, 1000);

function filterOrders(status) {
    const orders = document.querySelectorAll('.order-card');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    orders.forEach(order => {
        if (status === 'all' || order.dataset.status === status) {
            order.style.display = 'block';
        } else {
            order.style.display = 'none';
        }
    });
}

// Auto-refresh sound notification (optional)
function playNotificationSound() {
    // You can add a sound notification here if needed
    console.log('New order notification');
}

// Check for new orders periodically
setInterval(() => {
    // This would typically make an AJAX call to check for new orders
    // For now, we'll just reload the page
}, 30000);
</script>
{% endblock %}
