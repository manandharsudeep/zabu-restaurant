{% extends 'base.html' %}

{% block title %}Customer Analytics - Zabu Restaurant{% endblock %}

{% block extra_css %}
<style>
    .analytics-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #667eea;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .segment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .segment-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: 10px;
        border: 2px solid #e9ecef;
    }
    
    .segment-new { border-color: #ffc107; background: #fff3cd; }
    .segment-regular { border-color: #17a2b8; background: #d1ecf1; }
    .segment-loyal { border-color: #28a745; background: #d4edda; }
    .segment-vip { border-color: #dc3545; background: #f8d7da; }
    
    .segment-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .segment-new .segment-number { color: #856404; }
    .segment-regular .segment-number { color: #0c5460; }
    .segment-loyal .segment-number { color: #155724; }
    .segment-vip .segment-number { color: #721c24; }
    
    .top-customers {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .customer-row {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .customer-row:last-child {
        border-bottom: none;
    }
    
    .customer-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1rem;
        margin-right: 1rem;
    }
    
    .growth-chart {
        margin-top: 1.5rem;
    }
    
    .growth-bar {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .growth-month {
        width: 80px;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .growth-bar-container {
        flex: 1;
        height: 30px;
        background: #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        margin: 0 1rem;
    }
    
    .growth-bar-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 0.5rem;
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .growth-count {
        width: 40px;
        text-align: right;
        font-weight: bold;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}
<!-- Analytics Header -->
<div class="analytics-header">
    <div class="container">
        <div class="text-center">
            <h1 class="display-5">üìä Customer Analytics</h1>
            <p class="lead">Deep insights into customer behavior and trends</p>
        </div>
    </div>
</div>

<div class="container">
    <!-- Overview Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_customers }}</div>
            <div class="stat-label">Total Customers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ retention_rate|floatformat:1 }}%</div>
            <div class="stat-label">Retention Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ top_customers|length }}</div>
            <div class="stat-label">Top Spenders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ customer_growth|length }}</div>
            <div class="stat-label">Months Tracked</div>
        </div>
    </div>

    <!-- Customer Segments -->
    <div class="chart-container">
        <h3>üéØ Customer Segments</h3>
        <div class="segment-grid">
            <div class="segment-card segment-new">
                <div class="segment-number">{{ segments.new }}</div>
                <div class="stat-label">New Customers</div>
                <div class="text-muted small">1-2 orders</div>
            </div>
            <div class="segment-card segment-regular">
                <div class="segment-number">{{ segments.regular }}</div>
                <div class="stat-label">Regular</div>
                <div class="text-muted small">3-10 orders</div>
            </div>
            <div class="segment-card segment-loyal">
                <div class="segment-number">{{ segments.loyal }}</div>
                <div class="stat-label">Loyal</div>
                <div class="text-muted small">11-20 orders</div>
            </div>
            <div class="segment-card segment-vip">
                <div class="segment-number">{{ segments.vip }}</div>
                <div class="stat-label">VIP</div>
                <div class="text-muted small">20+ orders</div>
            </div>
        </div>
    </div>

    <!-- Customer Growth Chart -->
    <div class="chart-container">
        <h3>üìà Customer Growth Trend</h3>
        <div class="growth-chart">
            {% for growth in customer_growth %}
            <div class="growth-bar">
                <div class="growth-month">{{ growth.month }}</div>
                <div class="growth-bar-container">
                    <div class="growth-bar-fill" style="width: {% if growth.new_customers > 0 %}{{ growth.new_customers }}{% else %}0{% endif %}%">
                        {% if growth.new_customers > 5 %}{{ growth.new_customers }}{% endif %}
                    </div>
                </div>
                <div class="growth-count">{{ growth.new_customers }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Top Customers -->
    <div class="top-customers">
        <h3>üí∞ Top Customers by Spending</h3>
        <div class="mt-3">
            {% for customer_data in top_customers %}
            <div class="customer-row">
                <div class="customer-avatar">
                    {{ customer_data.customer.first_name.0|default:customer_data.customer.username.0|upper }}
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold">{{ customer_data.customer.get_full_name|default:customer_data.customer.username }}</div>
                    <div class="text-muted small">{{ customer_data.order_count }} orders ‚Ä¢ {{ customer_data.customer.email }}</div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">${{ customer_data.total_spent|floatformat:2 }}</div>
                    <div class="text-muted small">$0.00 avg</div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4">
                <p class="text-muted">No customer data available yet.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center mt-4">
        <a href="{% url 'customer_management' %}" class="btn btn-primary btn-lg me-2">
            üë• View All Customers
        </a>
        <a href="{% url 'export_customers' %}" class="btn btn-success btn-lg me-2">
            üìä Export Data
        </a>
        <a href="{% url 'menu_management:unified_management' %}" class="btn btn-secondary btn-lg">
            ‚Üê Back to Admin Dashboard
        </a>
    </div>
</div>

<script>
// Add interactive hover effects
document.querySelectorAll('.segment-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
        this.style.transition = 'all 0.3s ease';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
    });
});

// Animate growth bars on page load
document.addEventListener('DOMContentLoaded', function() {
    const bars = document.querySelectorAll('.growth-bar-fill');
    bars.forEach((bar, index) => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, index * 100);
    });
});
</script>
{% endblock %}
